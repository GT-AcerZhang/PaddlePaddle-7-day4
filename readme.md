目标检测7日打卡营-YOLO系列目标检测算法详解

地址：<https://aistudio.baidu.com/aistudio/education/group/info/1617> 

第四天：YOLO系列目标检测算法详解（9月24日）

  1. YOLO系列概览 

![下载 (1)](https://github.com/kjf4096/PaddlePaddle-7-day4/blob/master/%E4%B8%8B%E8%BD%BD%20(1).png)

![下载 (2)](https://github.com/kjf4096/PaddlePaddle-7-day4/blob/master/%E4%B8%8B%E8%BD%BD%20(2).png)

![下载 (3)](https://github.com/kjf4096/PaddlePaddle-7-day4/blob/master/%E4%B8%8B%E8%BD%BD%20(3).png)

![下载 (4)](https://github.com/kjf4096/PaddlePaddle-7-day4/blob/master/%E4%B8%8B%E8%BD%BD%20(4).png)

![下载 (5)](https://github.com/kjf4096/PaddlePaddle-7-day4/blob/master/%E4%B8%8B%E8%BD%BD%20(5).png)

![下载 (6)](https://github.com/kjf4096/PaddlePaddle-7-day4/blob/master/%E4%B8%8B%E8%BD%BD%20(6).png)

![下载 (7)](https://github.com/kjf4096/PaddlePaddle-7-day4/blob/master/%E4%B8%8B%E8%BD%BD%20(7).png)

![下载 (8)](https://github.com/kjf4096/PaddlePaddle-7-day4/blob/master/%E4%B8%8B%E8%BD%BD%20(8).png)

2. YOLOv3模块的详解 

![下载 (9)](https://github.com/kjf4096/PaddlePaddle-7-day4/blob/master/%E4%B8%8B%E8%BD%BD%20(9).png)



![下载 (10)](https://github.com/kjf4096/PaddlePaddle-7-day4/blob/master/%E4%B8%8B%E8%BD%BD%20(10).png)

![下载 (11)](https://github.com/kjf4096/PaddlePaddle-7-day4/blob/master/%E4%B8%8B%E8%BD%BD%20(11).png)

![下载 (12)](https://github.com/kjf4096/PaddlePaddle-7-day4/blob/master/%E4%B8%8B%E8%BD%BD%20(12).png)

![下载 (13)](https://github.com/kjf4096/PaddlePaddle-7-day4/blob/master/%E4%B8%8B%E8%BD%BD%20(13).png)

![下载 (14)](https://github.com/kjf4096/PaddlePaddle-7-day4/blob/master/%E4%B8%8B%E8%BD%BD%20(14).png)

![下载 (15)](https://github.com/kjf4096/PaddlePaddle-7-day4/blob/master/%E4%B8%8B%E8%BD%BD%20(15).png)

![下载 (16)](https://github.com/kjf4096/PaddlePaddle-7-day4/blob/master/%E4%B8%8B%E8%BD%BD%20(16).png)

![下载 (17)](https://github.com/kjf4096/PaddlePaddle-7-day4/blob/master/%E4%B8%8B%E8%BD%BD%20(17).png)

![下载 (18)](https://github.com/kjf4096/PaddlePaddle-7-day4/blob/master/%E4%B8%8B%E8%BD%BD%20(18).png)



![下载 (19)](https://github.com/kjf4096/PaddlePaddle-7-day4/blob/master/%E4%B8%8B%E8%BD%BD%20(19).png)

![下载 (20)](https://github.com/kjf4096/PaddlePaddle-7-day4/blob/master/%E4%B8%8B%E8%BD%BD%20(20).png)



![下载 (21)](https://github.com/kjf4096/PaddlePaddle-7-day4/blob/master/%E4%B8%8B%E8%BD%BD%20(21).png)

![下载 (22)](https://github.com/kjf4096/PaddlePaddle-7-day4/blob/master/%E4%B8%8B%E8%BD%BD%20(22).png)

![下载 (23)](https://github.com/kjf4096/PaddlePaddle-7-day4/blob/master/%E4%B8%8B%E8%BD%BD%20(23).png)

![下载 (24)](https://github.com/kjf4096/PaddlePaddle-7-day4/blob/master/%E4%B8%8B%E8%BD%BD%20(24).png)

![下载 (25)](https://github.com/kjf4096/PaddlePaddle-7-day4/blob/master/%E4%B8%8B%E8%BD%BD%20(25).png)

![下载 (26)](https://github.com/kjf4096/PaddlePaddle-7-day4/blob/master/%E4%B8%8B%E8%BD%BD%20(26).png)

![下载 (27)](https://github.com/kjf4096/PaddlePaddle-7-day4/blob/master/%E4%B8%8B%E8%BD%BD%20(27).png)

![下载 (28)](https://github.com/kjf4096/PaddlePaddle-7-day4/blob/master/%E4%B8%8B%E8%BD%BD%20(28).png)



![下载 (29)](https://github.com/kjf4096/PaddlePaddle-7-day4/blob/master/%E4%B8%8B%E8%BD%BD%20(29).png)

3 . PaddleDetection中YOLOv3模型介绍

![下载 (30)](https://github.com/kjf4096/PaddlePaddle-7-day4/blob/master/%E4%B8%8B%E8%BD%BD%20(30).png)

![下载 (31)](https://github.com/kjf4096/PaddlePaddle-7-day4/blob/master/%E4%B8%8B%E8%BD%BD%20(31).png)

![下载 (32)](https://github.com/kjf4096/PaddlePaddle-7-day4/blob/master/%E4%B8%8B%E8%BD%BD%20(32).png)

![下载 (33)](https://github.com/kjf4096/PaddlePaddle-7-day4/blob/master/%E4%B8%8B%E8%BD%BD%20(33).png)

![下载 (34)](https://github.com/kjf4096/PaddlePaddle-7-day4/blob/master/%E4%B8%8B%E8%BD%BD%20(34).png)



![下载 (35)](https://github.com/kjf4096/PaddlePaddle-7-day4/blob/master/%E4%B8%8B%E8%BD%BD%20(35).png)

4.【实战】PP-YOLO工业质检缺陷检测 

![下载 (36)](https://github.com/kjf4096/PaddlePaddle-7-day4/blob/master/%E4%B8%8B%E8%BD%BD%20(36).png)

### 4.1 数据准备

首先将印刷电路板（PCB）瑕疵数据集与PaddleDetection代码解压到`~/work/`目录中：



```
# 解压数据集
!tar -xf data/data52914/PCB_DATASET.tar -C ~/work/
# 解压PaddleDetection源码
!tar -xf data/data52899/PaddleDetection.tar -C ~/work/
```

### 4.2 环境安装

需要安装PaddleDetection所需的依赖包, 执行以下命令即可安装：

```
%cd ~/work/PaddleDetection
! pip install -r requirements.txt
! pip install pycocotools
```

## 4.3 修改配置文件

PaddleDetection中提供的配置文件是在8卡GPU环境下的配置，我们需要调整配置文件： 包括最大训练轮数(max_iters)，类别数(num_classes)，学习率(LearningRate)相关参数，数据Reader中TrainReader与EvalReader数据集路径等参数。

提示：

- 为保证模型正常训练不出Nan，学习率要根据GPU卡数，batch size变换而做线性变换，比如这里我们将GPU卡数8->1，所以base_lr除以8即可；（这里为了收敛更快，base_lr除以了4）
- 训练轮数与Epoch转换关系：根据训练集数量与总batch_size大小计算epoch数，然后将epoch数换算得到训练总轮数max_iters。配置文件中batch_size=8，训练集数量为593，要训练36个Epoch，在单卡GPU上训练，max_iters=593x36/8=2669。同时需要计算milestones（学习率变化界限），一般在总epoch数的2/3和8/9处进行学习率的调整，所以milestones为: [1779, 2372]。（PS：建议增大训练轮数）

### yolov3_darknet_baseline.yml配置文件修改适配：

- max_iters: 2669
- num_classes: 6
- base_lr: 0.00025
- milestones: [1779, 2372]

### yolov3_darknet_baseline.yml的Reader修改适配：

TrainReader:

- image_dir: images
- anno_path: Annotations/train.json
- dataset_dir: /home/aistudio/work/PCB_DATASET

EvalReader:

- image_dir: images
- anno_path: Annotations/val.json
- dataset_dir: /home/aistudio/work/PCB_DATASET

TestReader:

- anno_path: /home/aistudio/work/PCB_DATASET/Annotations/val.json

### Anchor重新聚类（可选）

如果网络的Anchor大小适配当前数据集，可大幅提升mAP

```
python tools/anchor_cluster.py -c ../yolov3_darknet_baseline.yml -n 9 -s 608 -m v2 -i 1000
```

具体用法和参数解释可参考[自定义数据集](https://github.com/PaddlePaddle/PaddleDetection/blob/release/0.4/docs/tutorials/Custom_DataSet.md#3%E7%94%9F%E6%88%90anchor)文档的生成Anchor章节

Anchor重新聚类完成后，修改配置文件中`YOLOv3Head`里的`anchors`字段，和TrainReader的`Gt2YoloTarget`中`anchors`字段即可。

### 数据预处理

数据扩充变换的操作在像COCO这种大规模数据集中，对提升mAP效果明显，在很小规模数据集中，如果随机数据处理操作太多，会使网络收敛速度变慢，对mAP的提升也没有帮助。所以在baseline中将非必须的随机数据增强操作注释掉了。

## 4.4 训练

如果通过以上方法修改完成配置文件后，就可以开始训练模型了：



```
! python tools/anchor_cluster.py -c ../yolov3_darknet_baseline.yml -n 9 -s 608 -m v2 -i 1000
2020-09-24 17:08:31,578-INFO: font search path ['/opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages/matplotlib/mpl-data/fonts/ttf', '/opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages/matplotlib/mpl-data/fonts/afm', '/opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages/matplotlib/mpl-data/fonts/pdfcorefonts']
2020-09-24 17:08:32,014-INFO: generated new fontManager
loading annotations into memory...
Done (t=0.01s)
creating index...
index created!
100%|██████████████████████████████████████| 593/593 [00:00<00:00, 40954.74it/s]
2020-09-24 17:08:32,470-INFO: Running kmeans for 9 anchors on 2527 points...
avg_iou: 0.7996:   0%|                                 | 0/1000 [00:00<?, ?it/s]
2020-09-24 17:08:32,546-INFO: 9 anchor cluster result: [w, h]
2020-09-24 17:08:32,546-INFO: [8, 13]
2020-09-24 17:08:32,546-INFO: [13, 14]
2020-09-24 17:08:32,546-INFO: [10, 21]
2020-09-24 17:08:32,546-INFO: [21, 13]
2020-09-24 17:08:32,547-INFO: [16, 20]
2020-09-24 17:08:32,547-INFO: [12, 31]
2020-09-24 17:08:32,547-INFO: [30, 17]
2020-09-24 17:08:32,547-INFO: [22, 27]
2020-09-24 17:08:32,547-INFO: [36, 36]
```

! python -u tools/train.py -c ../yolov3_darknet_baseline.yml --eval 



### 4.5 评估与预测

训练完成后，计算效果最好模型的mAP，运行：

In [9]

```
! python -u tools/eval.py -c ../yolov3_darknet_baseline.yml \
                -o weights=output/yolov3_darknet_baseline/best_model
                

```

```
loading annotations into memory...
Done (t=0.00s)
creating index...
index created!
2020-09-25 08:12:35,786-INFO: places would be ommited when DataLoader is not iterable
W0925 08:12:35.826665 28703 device_context.cc:252] Please NOTE: device: 0, CUDA Capability: 70, Driver API Version: 10.1, Runtime API Version: 9.0
W0925 08:12:35.831878 28703 device_context.cc:260] device: 0, cuDNN Version: 7.6.
2020-09-25 08:12:43,963-INFO: Test iter 0
2020-09-25 08:12:46,021-INFO: Test finish iter 13
2020-09-25 08:12:46,022-INFO: Total number of images: 100, inference time: 20.461959904880736 fps.
loading annotations into memory...
Done (t=0.00s)
creating index...
index created!
2020-09-25 08:12:46,033-INFO: Start evaluate...
Loading and preparing results...
DONE (t=0.01s)
creating index...
index created!
Running per image evaluation...
Evaluate annotation type *bbox*
DONE (t=0.23s).
Accumulating evaluation results...
DONE (t=0.14s).
 Average Precision  (AP) @[ IoU=0.50:0.95 | area=   all | maxDets=100 ] = 0.533
 Average Precision  (AP) @[ IoU=0.50      | area=   all | maxDets=100 ] = 0.982
 Average Precision  (AP) @[ IoU=0.75      | area=   all | maxDets=100 ] = 0.508
 Average Precision  (AP) @[ IoU=0.50:0.95 | area= small | maxDets=100 ] = 0.405
 Average Precision  (AP) @[ IoU=0.50:0.95 | area=medium | maxDets=100 ] = 0.536
 Average Precision  (AP) @[ IoU=0.50:0.95 | area= large | maxDets=100 ] = 0.483
 Average Recall     (AR) @[ IoU=0.50:0.95 | area=   all | maxDets=  1 ] = 0.140
 Average Recall     (AR) @[ IoU=0.50:0.95 | area=   all | maxDets= 10 ] = 0.607
 Average Recall     (AR) @[ IoU=0.50:0.95 | area=   all | maxDets=100 ] = 0.607
 Average Recall     (AR) @[ IoU=0.50:0.95 | area= small | maxDets=100 ] = 0.425
 Average Recall     (AR) @[ IoU=0.50:0.95 | area=medium | maxDets=100 ] = 0.614
 Average Recall     (AR) @[ IoU=0.50:0.95 | area= large | maxDets=100 ] = 0.502
terminate called without an active exception
W0925 08:12:46.708323 28772 init.cc:226] Warning: PaddlePaddle catches a failure signal, it may not work properly
W0925 08:12:46.708357 28772 init.cc:228] You could check whether you killed PaddlePaddle thread/process accidentally or report the case to PaddlePaddle
W0925 08:12:46.708364 28772 init.cc:231] The detail failure signal is:

W0925 08:12:46.708371 28772 init.cc:234] *** Aborted at 1600992766 (unix time) try "date -d @1600992766" if you are using GNU date ***
W0925 08:12:46.710121 28772 init.cc:234] PC: @                0x0 (unknown)
W0925 08:12:46.710249 28772 init.cc:234] *** SIGABRT (@0x3e80000701f) received by PID 28703 (TID 0x7ff069a6d700) from PID 28703; stack trace: ***
W0925 08:12:46.711588 28772 init.cc:234]     @     0x7ff119397390 (unknown)
W0925 08:12:46.712844 28772 init.cc:234]     @     0x7ff118ff1428 gsignal
W0925 08:12:46.714002 28772 init.cc:234]     @     0x7ff118ff302a abort
W0925 08:12:46.714879 28772 init.cc:234]     @     0x7ff0d9d6784a __gnu_cxx::__verbose_terminate_handler()
W0925 08:12:46.715649 28772 init.cc:234]     @     0x7ff0d9d65f47 __cxxabiv1::__terminate()
W0925 08:12:46.716501 28772 init.cc:234]     @     0x7ff0d9d65f7d std::terminate()
W0925 08:12:46.717255 28772 init.cc:234]     @     0x7ff0d9d65c5a __gxx_personality_v0
W0925 08:12:46.718042 28772 init.cc:234]     @     0x7ff0da098b97 _Unwind_ForcedUnwind_Phase2
W0925 08:12:46.718736 28772 init.cc:234]     @     0x7ff0da098e7d _Unwind_ForcedUnwind
W0925 08:12:46.719924 28772 init.cc:234]     @     0x7ff119396070 __GI___pthread_unwind
W0925 08:12:46.721060 28772 init.cc:234]     @     0x7ff11938e845 __pthread_exit
W0925 08:12:46.721331 28772 init.cc:234]     @     0x563f0709fe59 PyThread_exit_thread
W0925 08:12:46.721406 28772 init.cc:234]     @     0x563f06f25c17 PyEval_RestoreThread.cold.798
W0925 08:12:46.722249 28772 init.cc:234]     @     0x7ff10b35c29c (unknown)
W0925 08:12:46.722512 28772 init.cc:234]     @     0x563f07021744 _PyMethodDef_RawFastCallKeywords
W0925 08:12:46.722734 28772 init.cc:234]     @     0x563f07021861 _PyCFunction_FastCallKeywords
W0925 08:12:46.722954 28772 init.cc:234]     @     0x563f0708d2bd _PyEval_EvalFrameDefault
W0925 08:12:46.723170 28772 init.cc:234]     @     0x563f06fd1539 _PyEval_EvalCodeWithName
W0925 08:12:46.723377 28772 init.cc:234]     @     0x563f06fd2635 _PyFunction_FastCallDict
W0925 08:12:46.723601 28772 init.cc:234]     @     0x563f06ff0e53 _PyObject_Call_Prepend
W0925 08:12:46.723726 28772 init.cc:234]     @     0x563f07028a3a slot_tp_call
W0925 08:12:46.723932 28772 init.cc:234]     @     0x563f070298fb _PyObject_FastCallKeywords
W0925 08:12:46.724162 28772 init.cc:234]     @     0x563f0708ce86 _PyEval_EvalFrameDefault
W0925 08:12:46.724370 28772 init.cc:234]     @     0x563f06fd256b _PyFunction_FastCallDict
W0925 08:12:46.724566 28772 init.cc:234]     @     0x563f06ff0e53 _PyObject_Call_Prepend
W0925 08:12:46.724673 28772 init.cc:234]     @     0x563f07028a3a slot_tp_call
W0925 08:12:46.724876 28772 init.cc:234]     @     0x563f070298fb _PyObject_FastCallKeywords
W0925 08:12:46.725104 28772 init.cc:234]     @     0x563f0708d6e8 _PyEval_EvalFrameDefault
W0925 08:12:46.725307 28772 init.cc:234]     @     0x563f06fd1539 _PyEval_EvalCodeWithName
W0925 08:12:46.725509 28772 init.cc:234]     @     0x563f06fd2635 _PyFunction_FastCallDict
W0925 08:12:46.725705 28772 init.cc:234]     @     0x563f06ff0e53 _PyObject_Call_Prepend
W0925 08:12:46.725924 28772 init.cc:234]     @     0x563f06fe3dbe PyObject_Call
Aborted (core dumped)
```

最终结果：

 Average Precision  (AP) @[ IoU=0.50      | area=   all | maxDets=100 ] = ==0.982==

效果还算可以
